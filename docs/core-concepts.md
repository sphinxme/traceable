---
description: Description of the overall architecture and data structure
globs: 
alwaysApply: false
---
# Traceable: Project Core Concepts and Data Models

## 1. Overview

This document outlines the central concepts and data structures used within the Traceable application. Understanding these is key to comprehending the application's functionality, data flow, and how different parts of the system interact. The data is primarily managed using Yjs, enabling local-first persistence via IndexedDB and real-time multi-device synchronization via Liveblocks.

## 2. Core Entities & Data Models

The application revolves around two primary user-facing concepts: **Tasks** (for the todolist view) and **Events** (for the calendar/scheduling view). These are supported by several underlying data structures and managers.

### 2.1. Task (`TaskProxy`)

*   **Concept:** Represents a single to-do item or a project/sub-project in the infinitely nested todolist. It's the fundamental unit of the "todo view."
*   **Core Idea:** "事事可追溯" (Traceable) – tasks can be linked in complex ways, and their history/connections are maintained.
*   **Key File:** `src/lib/states/meta/task.svelte.ts` (defines `TaskProxy` and `TaskProxyManager`)
*   **Key Attributes & Relationships:**
    *   `id: string`: Unique identifier for the task. Generated by `src/lib/states/meta/utils.ts` (`ObjectID().toHexString()`).
    *   `textId: string`: Identifier for the `Y.Text` object holding the task's name/title.
    *   `noteId: string`: Identifier for the `Y.Text` object holding the task's descriptive notes.
    *   `text: Y.Text`: (Accessed via `textId`) The Yjs shared type for the task's main content/title. Allows collaborative editing of the task name.
        *   Managed by `TaskProxyManager` which uses `textRepository: YTextFactory` (implemented by `Repository`).
    *   `note: Y.Text`: (Accessed via `noteId`) The Yjs shared type for the task's detailed notes. Allows collaborative editing of the note.
        *   Managed by `TaskProxyManager` which uses `textRepository: YTextFactory`.
    *   `children: TaskProxyIterable (Y.Array<string>)`: An ordered list of child task IDs. This forms the nested structure. `TaskProxyIterable` is a wrapper around `Y.Array<string>` found in `src/lib/states/meta/array.ts`.
    *   `parents: TaskProxyIterable (Y.Array<string>)`: A list of parent task IDs. This enables **bidirectional linking**, allowing a task to appear under multiple parent tasks.
    *   `events: EventProxyIterable (Y.Array<string>)`: A list of associated `EventProxy` IDs, linking a task to its scheduled time blocks in the calendar.
    *   `status: 'DONE' | 'TODO' | 'BLOCKED'`: The current completion status of the task.
*   **Yjs Implementation:**
    *   A `TaskProxy` wraps a `Y.Map<any>` that stores the task's own attributes (`id`, `textId`, `noteId`, `status`) and Yjs shared types for collections (`children` as `Y.Array`, `parents` as `Y.Array`, `events` as `Y.Array`).
    *   The actual textual content (`text`, `note`) is stored in separate `Y.Text` objects within the `texts` Y.Map in the `Repository`, referenced by `textId` and `noteId`.
*   **Management:**
    *   `TaskProxyManager` (`src/lib/states/meta/task.svelte.ts`): Responsible for creating, retrieving (building), and deleting `TaskProxy` instances and their associated `Y.Text` for text/note.
    *   It interacts with `YTaskFactory` and `YTextFactory` (interfaces implemented by `Repository` in `src/lib/states/yjs/repository.ts`) for Yjs data operations.

### 2.2. Event (`EventProxy`)

*   **Concept:** Represents a scheduled time block on the calendar, visually indicating when a `Task` is planned to be worked on.
*   **Key File:** `src/lib/states/meta/event.svelte.ts` (defines `EventProxy` and `EventProxyManager`)
*   **Key Attributes & Relationships:**
    *   `id: string`: Unique identifier for the event.
    *   `taskId: string`: The ID of the **unique** `TaskProxy` this event is associated with. This is a one-to-many relationship from Task to Event (one task can have many events, but one event belongs to only one task).
    *   `task: TaskProxy`: The actual `TaskProxy` instance.
    *   `start: number`: Timestamp (milliseconds) for the event's start time.
    *   `end: number`: Timestamp (milliseconds) for the event's end time.
*   **Yjs Implementation:**
    *   An `EventProxy` wraps a `Y.Map<any>` that stores `id`, `taskId`, `start`, and `end`.
*   **Management:**
    *   `EventProxyManager` (`src/lib/states/meta/event.svelte.ts`): Responsible for creating, retrieving, and managing `EventProxy` instances. It links events to tasks using `TaskProxyManager`.
    *   It interacts with `YEventRepository` (interface implemented by `Repository`) for Yjs data operations.

### 2.3. Text / Note (via `Y.Text`)

*   **Concept:** Represents mutable textual content, primarily used for a `Task`'s name (`text`) and its description (`note`).
*   **Key File:** `src/lib/states/yjs/repository.ts` (methods `newYText`, `getYText`) and `src/lib/states/meta/task.svelte.ts` (where `TaskProxy` uses `textId` and `noteId`).
*   **Implementation:**
    *   These are not separate high-level proxy classes like `TaskProxy` or `EventProxy`.
    *   They are `Y.Text` objects stored in a dedicated `Y.Map` (named `texts`) within the main Yjs document (see `Repository`).
    *   Each `TaskProxy` holds `textId` and `noteId` which are keys to retrieve the corresponding `Y.Text` objects from the `texts` map in the `Repository`.
    *   The `Quill` editor component (`src/lib/components/quill/quill.ts`) binds directly to these `Y.Text` instances for rich text editing.

### 2.4. Journal (`JournalProxy`)

*   **Concept:** Represents a special type of task, often associated with a specific time period and type (e.g., a weekly journal entry acting as a container for tasks of that week).
*   **Key File:** `src/lib/states/meta/journal.svelte.ts`
*   **Key Attributes & Relationships:**
    *   `id: string`: Unique identifier, typically generated from `time` and `type`.
    *   `time: Dayjs`: Timestamp representing the journal's period (e.g., start of the week).
    *   `type: JournalType` (e.g., `"WEEK"`).
    *   `taskId: string`: The ID of the `TaskProxy` that represents this journal entry's content. This means a `JournalProxy` essentially *is* a `TaskProxy` with additional time/type metadata.
    *   `task: TaskProxy`: The actual `TaskProxy` instance.
*   **Yjs Implementation:**
    *   A `JournalProxy` wraps a `Y.Map<any>` storing `id`, `type`, `taskId`, and `time`.
*   **Management:**
    *   `JournalProxyManager`: Manages `JournalProxy` instances.
    *   `JournalProxyManager.genKey(time, type)`: Generates the ID for journals.

### 2.5. User (`UserManager`)

*   **Concept:** Represents user-specific root information or preferences.
*   **Key File:** `src/lib/states/meta/user.svelte.ts`
*   **Key Attributes & Relationships:**
    *   `rootTaskId: string`: The ID of the top-level `TaskProxy` that serves as the entry point for the user's entire todolist structure.
    *   `rootTask: TaskProxy`: The actual root `TaskProxy` instance.
*   **Yjs Implementation:**
    *   User-specific data is stored in a `Y.Map<any>` named `user` within the `Repository`. Currently, this primarily stores the `rootTaskId`.
*   **Management:**
    *   `UserManager`: Manages user-related data, ensuring a `rootTask` exists.

### 2.6. Yjs Repository Structure (`Repository`)

*   **Concept:** The `Repository` class acts as a centralized accessor and factory for Yjs shared types (CRDTs) that form the application's database schema.
*   **Key File:** `src/lib/states/yjs/repository.ts`
*   **Key Yjs Maps within the Y.Doc:**
    *   `tasks: Y.Map<Y.Map<any>>`: Stores all `TaskProxy` data. Key is task ID, value is a `Y.Map` representing the task.
    *   `texts: Y.Map<Y.Text>`: Stores all `Y.Text` objects for task names and notes. Key is text ID (e.g., `textId` from a task).
    *   `events: Y.Map<Y.Map<any>>`: Stores all `EventProxy` data. Key is event ID, value is a `Y.Map` representing the event.
    *   `journals: Y.Map<Y.Map<any>>`: Stores all `JournalProxy` data. Key is journal ID.
    *   `panelStates: Y.Map<any>`: Stores UI state for different panels (e.g., folded states, navigation paths). See `src/lib/states/states/panel_states.ts`.
    *   `user: Y.Map<any>`: Stores user-specific data, like `rootTaskId`.
*   **Functionality:** Provides methods to create (`newYTask`, `newYText`, `newYEvent`), retrieve (`getYTask`, `getYText`, `getYEvent`), and delete Yjs data structures.

### 2.7. Panel States (`EditorPanelState`, `JournalPanelState`, `EditorItemState`)

*   **Concept:** Manages the UI state of various panels, such as the current navigation path within the todolist (zoom level) and the folded/unfolded state of tasks within those panels. This state is also persisted using Yjs to be consistent across sessions and devices.
*   **Key File:** `src/lib/states/states/panel_states.ts`
*   **`EditorPanelState`:**
    *   `id: string`: Panel identifier.
    *   `paths: BehaviorSubject<TaskProxy[]>`: An RxJS BehaviorSubject holding the current navigation path (array of `TaskProxy` from the root to the currently "zoomed-in" task). This is primarily local component state, not directly a Yjs type itself, but derived from and influences Yjs-persisted states.
    *   `foldStatesTree: Y.Map<any>`: A Yjs Map storing the folded state for tasks within this panel's context. It's a nested map structure mirroring the task hierarchy.
*   **`JournalPanelState`:**
    *   Similar to `EditorPanelState` but tailored for journal views. It also maintains `foldStatesTree`.
*   **`EditorItemState`:**
    *   Represents the state of an individual task item as displayed in an editor panel.
    *   `task: TaskProxy`: The task this state pertains to.
    *   `folded: boolean`: Whether this task item is currently folded (children hidden). This value is read from/written to the `foldStatesTree` of its parent `EditorPanelState` or `JournalPanelState`.
    *   `relativePath: TaskProxy[]`: Path from the panel's current root to this item.
    *   `currentParentPath: TaskProxy[]`: Path from the absolute application root to the panel's current root.
*   **Yjs Implementation:**
    *   The `panelStates` Y.Map in the `Repository` stores these panel-specific states. Each panel (identified by a panel ID) will have its own entry, typically another `Y.Map` containing its `foldStatesTree`.

### 2.8. Database Orchestrator (`Database`)

*   **Concept:** A high-level class that initializes and holds references to the Yjs document (`Y.Doc`), the `Repository`, and all the primary data managers (`TaskProxyManager`, `EventProxyManager`, `JournalProxyManager`, `UserManager`).
*   **Key File:** `src/lib/states/meta/database.svelte.ts`
*   **Functionality:**
    *   Acts as the main entry point for accessing and manipulating application data.
    *   Provides `import()` and `export()` methods for serializing and deserializing the entire Yjs document content, useful for backups or migrations.
    *   Handles the setup of dependencies between managers (e.g., providing `EventProxyManager` to `TaskProxyManager`).

## 3. Data Flow & Synchronization

1.  **Yjs Document (`Y.Doc`):** The single source of truth for all mutable application data.
2.  **Repository (`Repository`):** Provides a structured way to access and modify Yjs shared types within the `Y.Doc`.
3.  **Proxy Managers (`TaskProxyManager`, `EventProxyManager`, etc.):** Offer a higher-level, object-oriented API over the `Repository`, managing instances of `TaskProxy`, `EventProxy`, etc. They encapsulate the logic for creating, linking, and manipulating these business objects.
4.  **Proxy Objects (`TaskProxy`, `EventProxy`):** Represent individual data entities and provide reactive properties (e.g., `task.text$`, `event.start$`) that UI components can subscribe to. Changes made to these proxies (or directly to their underlying Yjs types) are propagated through Yjs.
5.  **Svelte Components:** Subscribe to observables provided by Proxy objects or their managers to reactively update the UI. User interactions in the UI call methods on these Proxies or Managers to modify data.
6.  **Yjs Adapters:**
    *   `y-indexeddb` (`src/lib/states/yjs/load.ts`): Persists the `Y.Doc` to the browser's IndexedDB for local-first storage and offline access.
    *   `@liveblocks/yjs` (`src/lib/states/yjs/load.ts`): Connects the `Y.Doc` to Liveblocks services for real-time synchronization across multiple clients/devices.

This layered approach ensures that data is consistently managed, reactively updated in the UI, and efficiently synchronized.
